// <auto-generated/>
#pragma warning disable 1591
#pragma warning disable 0414
#pragma warning disable 0649
#pragma warning disable 0169

namespace BlazorServer.Pages
{
    #line hidden
    using System;
    using System.Collections.Generic;
    using System.Threading.Tasks;
    using Microsoft.AspNetCore.Components;
#nullable restore
#line 1 "c:\Users\hopki\OneDrive\Documents\Myaddon\Wickedaddon\WowClassicGrindBot\BlazorServer\_Imports.razor"
using System.Net.Http;

#line default
#line hidden
#nullable disable
#nullable restore
#line 2 "c:\Users\hopki\OneDrive\Documents\Myaddon\Wickedaddon\WowClassicGrindBot\BlazorServer\_Imports.razor"
using Microsoft.AspNetCore.Authorization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 3 "c:\Users\hopki\OneDrive\Documents\Myaddon\Wickedaddon\WowClassicGrindBot\BlazorServer\_Imports.razor"
using Microsoft.AspNetCore.Components.Authorization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 4 "c:\Users\hopki\OneDrive\Documents\Myaddon\Wickedaddon\WowClassicGrindBot\BlazorServer\_Imports.razor"
using Microsoft.AspNetCore.Components.Forms;

#line default
#line hidden
#nullable disable
#nullable restore
#line 5 "c:\Users\hopki\OneDrive\Documents\Myaddon\Wickedaddon\WowClassicGrindBot\BlazorServer\_Imports.razor"
using Microsoft.AspNetCore.Components.Routing;

#line default
#line hidden
#nullable disable
#nullable restore
#line 6 "c:\Users\hopki\OneDrive\Documents\Myaddon\Wickedaddon\WowClassicGrindBot\BlazorServer\_Imports.razor"
using Microsoft.AspNetCore.Components.Web;

#line default
#line hidden
#nullable disable
#nullable restore
#line 7 "c:\Users\hopki\OneDrive\Documents\Myaddon\Wickedaddon\WowClassicGrindBot\BlazorServer\_Imports.razor"
using Microsoft.JSInterop;

#line default
#line hidden
#nullable disable
#nullable restore
#line 8 "c:\Users\hopki\OneDrive\Documents\Myaddon\Wickedaddon\WowClassicGrindBot\BlazorServer\_Imports.razor"
using BlazorServer;

#line default
#line hidden
#nullable disable
#nullable restore
#line 9 "c:\Users\hopki\OneDrive\Documents\Myaddon\Wickedaddon\WowClassicGrindBot\BlazorServer\_Imports.razor"
using BlazorServer.Shared;

#line default
#line hidden
#nullable disable
#nullable restore
#line 10 "c:\Users\hopki\OneDrive\Documents\Myaddon\Wickedaddon\WowClassicGrindBot\BlazorServer\_Imports.razor"
using Core.Session;

#line default
#line hidden
#nullable disable
#nullable restore
#line 11 "c:\Users\hopki\OneDrive\Documents\Myaddon\Wickedaddon\WowClassicGrindBot\BlazorServer\_Imports.razor"
using BlazorTable;

#line default
#line hidden
#nullable disable
#nullable restore
#line 4 "c:\Users\hopki\OneDrive\Documents\Myaddon\Wickedaddon\WowClassicGrindBot\BlazorServer\Pages\RouteComponent.razor"
using System.Linq;

#line default
#line hidden
#nullable disable
#nullable restore
#line 5 "c:\Users\hopki\OneDrive\Documents\Myaddon\Wickedaddon\WowClassicGrindBot\BlazorServer\Pages\RouteComponent.razor"
using Core;

#line default
#line hidden
#nullable disable
    public partial class RouteComponent : Microsoft.AspNetCore.Components.ComponentBase
    {
        #pragma warning disable 1998
        protected override void BuildRenderTree(Microsoft.AspNetCore.Components.Rendering.RenderTreeBuilder __builder)
        {
        }
        #pragma warning restore 1998
#nullable restore
#line 89 "c:\Users\hopki\OneDrive\Documents\Myaddon\Wickedaddon\WowClassicGrindBot\BlazorServer\Pages\RouteComponent.razor"
       

    [Parameter]
    public int Size { get; set; } = 1024;

    private MarkupString RouteToWaypointLines = new MarkupString();
    private MarkupString RouteToWaypointPoints = new MarkupString();

    private MarkupString PathLines = new MarkupString();
    private MarkupString PathPoints = new MarkupString();

    private MarkupString SpiritLines = new MarkupString();
    private MarkupString SpiritPathPoints = new MarkupString();
    private System.Timers.Timer refreshTimer = new System.Timers.Timer();

    private bool CanvasInitialised = false;

    private List<WowPoint> Deaths = new List<WowPoint>();

    protected override void OnInitialized()
    {
        botController.ProfileLoaded -= OnProfileLoaded;
        botController.ProfileLoaded += OnProfileLoaded;

        ((Core.AddonReader)addonReader).AddonDataChanged += (o, e) =>
        {
            base.InvokeAsync(() =>
            {
                try
                {
                    InitialiseRoute();
                    StateHasChanged();
                }
                catch { }
            });
        };
    }

    private void InitialiseRoute()
    {
        if (botController.RouteInfo != null)
        {
            if (!CanvasInitialised)
            {
                CanvasInitialised = true;
                botController.RouteInfo.SetMargin(10);
                botController.RouteInfo.SetCanvasSize(Size);

                if (botController.GoapAgent != null)
                {
                    var walkToCorpseGoal = botController.GoapAgent.AvailableGoals.FirstOrDefault(a => a.GetType() == typeof(Core.Goals.WalkToCorpseGoal)) as Core.Goals.WalkToCorpseGoal;
                    if (walkToCorpseGoal != null)
                    {
                        Deaths = walkToCorpseGoal.Deaths;
                    }
                }
            }

            RefreshPathMarkup();

            if (!refreshTimer.Enabled)
            {
                refreshTimer.Interval = 10000;
                refreshTimer.Enabled = true;

                refreshTimer.Elapsed += (s, e) =>
                {
                    botController.RouteInfo.CalculatePointToGrid();
                    RefreshPathMarkup();
                };

                refreshTimer.Start();
            }
        }
    }

    private void RefreshPathMarkup()
    {
        var routeinfo = botController.RouteInfo;

        if (routeinfo != null)
        {
            this.PathLines = new MarkupString(routeinfo.RenderPathLines(routeinfo.PathPoints));
            this.PathPoints = new MarkupString(routeinfo.RenderPathPoints(routeinfo.PathPoints));

            this.SpiritLines = new MarkupString(routeinfo.RenderPathLines(routeinfo.SpiritPath));
            this.SpiritPathPoints = new MarkupString(routeinfo.RenderPathPoints(routeinfo.SpiritPath));

            var routeToWaypoints = routeinfo.RouteToWaypoint;
            this.RouteToWaypointLines = new MarkupString(routeinfo.RenderPathLines(routeToWaypoints));
            this.RouteToWaypointPoints = new MarkupString(routeinfo.RenderPathPoints(routeToWaypoints));
        }
    }

    protected override async System.Threading.Tasks.Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JSRuntime.InvokeAsync<string>("draw");
        }
    }

    private void OnProfileLoaded(object? sender, EventArgs e)
    {
        CanvasInitialised = false;
    }

#line default
#line hidden
#nullable disable
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private IJSRuntime JSRuntime { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private Core.IBotController botController { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private Core.IAddonReader addonReader { get; set; }
    }
}
#pragma warning restore 1591
